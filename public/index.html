<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Animal Bite Clinic Dashboard</title>

    <link href="https://fonts.googleapis.com/css?family=Poppins:400,500,600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/CSS/dashy.css">
    <link rel="stylesheet" href="/CSS/dashboard.css">
    <link rel="stylesheet" href="/CSS/style.css">
    <link rel="stylesheet" href="/CSS/admin.css">
    <link rel="stylesheet" href="/CSS/billing.css">
    <link rel="stylesheet" href="/CSS/bite_record.css">
    <link rel="stylesheet" href="/CSS/checkins.css">
    <link rel="stylesheet" href="/CSS/code.css">
    <link rel="stylesheet" href="/CSS/emergency.css">
    <link rel="stylesheet" href="/CSS/register.css">
    <link rel="stylesheet" href="/CSS/report.css">
    <link rel="stylesheet" href="/CSS/sms.css">
    <link rel="stylesheet" href="/CSS/wristbands.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/Javascript/dashboard.js"></script>
    <script src="/Javascript/billing.js"></script>
    <script src="/Javascript/bite_record.js"></script>
    <script src="/Javascript/checkins.js"></script>
    <!-- firebase and login scripts are loaded later (after compat SDKs) to ensure firebase is available -->
    <!-- Confirmation modal (hidden by default). The async confirmAction shows this modal and resolves when user chooses. -->
    <div id="confirm-modal" class="confirm-modal" aria-hidden="true" role="dialog" aria-modal="true">
        <div class="confirm-modal-backdrop"></div>
        <div class="confirm-modal-panel" role="document" aria-labelledby="confirm-modal-title">
            <div class="confirm-modal-content">
                <h3 id="confirm-modal-title">Confirm action</h3>
                <p id="confirm-modal-message">Are you sure?</p>
                <div class="confirm-modal-actions">
                    <button id="confirm-cancel" class="btn btn-secondary">Cancel</button>
                    <button id="confirm-ok" class="btn btn-primary">Confirm</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Async confirmation helper using the modal above. Returns a Promise<boolean>.
        (function(){
            var modal = document.getElementById('confirm-modal');
            var messageEl = document.getElementById('confirm-modal-message');
            var okBtn = document.getElementById('confirm-ok');
            var cancelBtn = document.getElementById('confirm-cancel');

            function showModal(message) {
                return new Promise(function(resolve){
                    try {
                        messageEl.textContent = message || 'Are you sure you want to continue?';
                        modal.setAttribute('aria-hidden', 'false');
                        modal.style.display = 'block';
                        // focus management
                        okBtn.focus();

                        function cleanup() {
                            okBtn.removeEventListener('click', onOk);
                            cancelBtn.removeEventListener('click', onCancel);
                            document.removeEventListener('keydown', onKey);
                        }

                        function hide() {
                            modal.setAttribute('aria-hidden', 'true');
                            modal.style.display = 'none';
                        }

                        function onOk() { cleanup(); hide(); resolve(true); }
                        function onCancel() { cleanup(); hide(); resolve(false); }
                        function onKey(e) { if (e.key === 'Escape') { onCancel(); } }

                        okBtn.addEventListener('click', onOk);
                        cancelBtn.addEventListener('click', onCancel);
                        document.addEventListener('keydown', onKey);
                    } catch (e) {
                        console.error('showModal error', e);
                        resolve(false);
                    }
                });
            }

            window.confirmAction = function(message, callback) {
                // backward compatible: callback-based API
                showModal(message).then(function(confirmed){
                    if (confirmed && typeof callback === 'function') {
                        try { callback(); } catch (e) { console.error('confirmAction callback error', e); }
                    }
                }).catch(function(){ if (typeof callback === 'function') {} });
                return showModal(message);
            };
        })();
    </script>
    <script src="/Javascript/report.js"></script>
    <script src="/Javascript/schedule_doses.js"></script>
    <script src="/Javascript/sms.js"></script>
    <script src="/Javascript/staff_management.js"></script>
    <script src="/Javascript/wristbands.js"></script>
</head>
<body>
    <!-- Auth overlay: shown while we check Firebase auth state to avoid UI flash -->
    <div id="auth-overlay" class="auth-overlay">
        <div class="auth-message">
            <div class="auth-spinner" aria-hidden="true"></div>
            <div>Checking authentication…</div>
        </div>
    </div>
    <script>
        (function(){
            // If the site is opened at the root, wait for Firebase auth to decide:
            // - if user signed in -> hide overlay and initialize app (bottom listener will run)
            // - if no user -> redirect to /login.html
            var p = window.location.pathname || '/';
            var normalized = p.toLowerCase();
            if (!(normalized === '/' || normalized.endsWith('/index.html'))) {
                // not the root; hide overlay so fragments can render when included
                var ao = document.getElementById('auth-overlay'); if (ao) ao.style.display = 'none';
                return;
            }

            var resolved = false;
            function onNoUser() {
                if (resolved) return; resolved = true;
                window.location.replace('/login.html');
            }

            function onUser() {
                if (resolved) return; resolved = true;
                var ao = document.getElementById('auth-overlay'); if (ao) ao.style.display = 'none';
                // app initialization is handled by the listener at the bottom of this file
            }

            function waitForFirebaseAuth() {
                if (window.firebase && firebase.auth) {
                    // listen once
                    var unsub = firebase.auth().onAuthStateChanged(function(user){
                        if (unsub) try{ unsub(); }catch(_){ }
                        if (user) onUser(); else onNoUser();
                    });
                } else {
                    var t = setInterval(function(){ if (window.firebase && firebase.auth) { clearInterval(t); waitForFirebaseAuth(); } }, 100);
                    // safety fallback: if firebase never loads, redirect to login after 5s
                    setTimeout(function(){ clearInterval(t); if (!resolved) onNoUser(); }, 5000);
                }
            }

            waitForFirebaseAuth();
        })();
    </script>
    <div class="dashboard">
        <aside class="sidebar">
            <div class="logo">
                <img src="/icons/meow_white.png" alt="Logo">
                <h2>Animal Bite Clinic</h2>
            </div>
            <ul class="menu">
                <li class="active" onclick="loadPage('/pages/dashboard.html', this)">
                    <img src="/icons/dash-icons/1.png" alt=""> Dashboard
                </li>
                <li onclick="loadPage('/pages/animal_bite_record.html', this)">
                    <img src="/icons/dash-icons/2.png" alt=""> Animal Bite Record
                </li>
                <li onclick="loadPage('/pages/register.html', this)">
                    <img src="/icons/dash-icons/3.png" alt=""> Register Patient
                </li>
                <li onclick="loadPage('/pages/wristbands.html', this)">
                    <img src="/icons/dash-icons/4.png" alt=""> Wristbands
                </li>
                <li onclick="loadPage('/pages/checkins.html', this)">
                    <img src="/icons/dash-icons/5.png" alt=""> Check-ins
                </li>
                <li onclick="loadPage('/pages/billing.html', this)">
                    <img src="/icons/dash-icons/6.png" alt=""> Billing/Payment
                </li>
                <li onclick="loadPage('/pages/sms.html', this)">
                    <img src="/icons/dash-icons/7.png" alt=""> SMS Notifications
                </li>
                <li onclick="loadPage('/pages/report.html', this)">
                    <img src="/icons/dash-icons/8.png" alt=""> Report & Analysis
                </li>
                <li onclick="loadPage('/pages/emergency.html', this)">
                    <img src="/icons/dash-icons/9.png" alt=""> Emergency Protocols
                </li>
                <li onclick="logout()">
                    <img src="/icons/dash-icons/master.png" alt=""> Logout
                </li>
            </ul>
        </aside>

        <main class="main-content" id="main-content">
            </main>
    </div>
    <script>
        function loadPage(url, element) {
            fetch(url)
                .then(res => res.text())
                .then(html => {
                    const mainContent = document.getElementById('main-content');
                    mainContent.innerHTML = html;

                    if (url.includes('dashboard.html')) {
                        if (typeof Chart === 'undefined') {
                            console.error('Chart.js is not available');
                            return;
                        }

                        const script = document.createElement('script');
                        script.src = '/Javascript/dashboard.js';
                        mainContent.appendChild(script);

                        script.onload = () => {
                            setTimeout(() => {
                                if (typeof initializeCharts === 'function') {
                                    initializeCharts();
                                } else {
                                    console.error('initializeCharts function not found');
                                }
                                if (typeof loadDashboardStats === 'function') {
                                    loadDashboardStats();
                                }
                            }, 100);
                        };
                    }

                    if (url.includes('animal_bite_record.html')) {
                        if (!document.querySelector('link[href="/CSS/bite_record.css"]')) {
                            const link = document.createElement('link');
                            link.rel = 'stylesheet';
                            link.href = '/CSS/bite_record.css';
                            document.head.appendChild(link);
                        }
                        const existing = document.getElementById('bite-record-js');
                        if (existing) existing.remove();
                        const script = document.createElement('script');
                        script.src = '/Javascript/bite_record.js';
                        script.id = 'bite-record-js';
                        mainContent.appendChild(script);
                        script.onload = () => {
                            if (typeof loadBiteRecords === 'function') {
                                loadBiteRecords();
                            }
                        };
                    }

                    if (url.includes('register.html')) {
                        if (!document.querySelector('link[href="/CSS/register.css"]')) {
                            const link = document.createElement('link');
                            link.rel = 'stylesheet';
                            link.href = '/CSS/register.css';
                            document.head.appendChild(link);
                        }
                        if (typeof initRegisterForm === 'function') {
                            initRegisterForm();
                        }
                    }

                    if (url.includes('checkins.html')) {
                        if (!document.querySelector('link[href="/CSS/checkins.css"]')) {
                            const link = document.createElement('link');
                            link.rel = 'stylesheet';
                            link.href = '/CSS/checkins.css';
                            document.head.appendChild(link);
                        }
                        const existing = document.getElementById('checkins-js');
                        if (existing) existing.remove();
                        const script = document.createElement('script');
                        script.src = '/Javascript/checkins.js';
                        script.id = 'checkins-js';
                        mainContent.appendChild(script);
                    }

                    if (url.includes('wristbands.html')) {
                        if (!document.querySelector('link[href="/CSS/wristbands.css"]')) {
                            const link = document.createElement('link');
                            link.rel = 'stylesheet';
                            link.href = '/CSS/wristbands.css';
                            document.head.appendChild(link);
                        }
                        const existingW = document.getElementById('wristbands-js');
                        if (existingW) existingW.remove();
                        const scriptW = document.createElement('script');
                        scriptW.src = '/Javascript/wristbands.js';
                        scriptW.id = 'wristbands-js';
                        mainContent.appendChild(scriptW);
                        scriptW.onload = () => { 
                            if (typeof loadWristbands === 'function') loadWristbands();
                            if (typeof initWristbandsPage === 'function') initWristbandsPage();
                        };
                    }

                    if (url.includes('billing.html')) {
                        if (!document.querySelector('link[href="/CSS/billing.css"]')) {
                            const link = document.createElement('link');
                            link.rel = 'stylesheet';
                            link.href = '/CSS/billing.css';
                            document.head.appendChild(link);
                        }
                        const existingB = document.getElementById('billing-js');
                        if (existingB) existingB.remove();
                        const scriptB = document.createElement('script');
                        scriptB.src = '/Javascript/billing.js';
                        scriptB.id = 'billing-js';
                        mainContent.appendChild(scriptB);
                        scriptB.onload = () => {
                            if (typeof initializeBilling === 'function') {
                                initializeBilling();
                            }
                            if (typeof populatePatientSelect === 'function') {
                                populatePatientSelect();
                            }
                            if (typeof initBillingData === 'function') {
                                initBillingData();
                            }
                        };
                    }

                    if (url.includes('report.html')) {
                        if (!document.querySelector('link[href="/CSS/report.css"]')) {
                            const link = document.createElement('link');
                            link.rel = 'stylesheet';
                            link.href = '/CSS/report.css';
                            document.head.appendChild(link);
                        }
                        const existing = document.getElementById('report-js');
                        if (existing) existing.remove();
                        const script = document.createElement('script');
                        script.src = '/Javascript/report.js';
                        script.id = 'report-js';
                        mainContent.appendChild(script);
                    }

                    if (url.includes('admin/dashboard.html')) {
                        const script = document.createElement('script');
                        script.src = '/Javascript/dashboard.js';
                        mainContent.appendChild(script);
                        script.onload = () => {
                            if (typeof initializeCharts === 'function') initializeCharts();
                            if (typeof loadDashboardStats === 'function') loadDashboardStats();
                        };
                    }
                    if (url.includes('admin/animal_bite_record.html')) {
                        if (!document.querySelector('link[href="/CSS/bite_record.css"]')) {
                            const link = document.createElement('link');
                            link.rel = 'stylesheet';
                            link.href = '/CSS/bite_record.css';
                            document.head.appendChild(link);
                        }
                        const existing = document.getElementById('bite-record-js');
                        if (existing) existing.remove();
                        const script = document.createElement('script');
                        script.src = '/Javascript/bite_record.js';
                        script.id = 'bite-record-js';
                        mainContent.appendChild(script);
                        script.onload = () => { 
                            if (typeof loadBiteRecords === 'function') loadBiteRecords(); 
                            if (typeof initBiteRecordPage === 'function') initBiteRecordPage();
                        };
                    }
                    if (url.includes('admin/sms.html')) {
                        if (!document.querySelector('link[href="/CSS/sms.css"]')) {
                            const link = document.createElement('link');
                            link.rel = 'stylesheet';
                            link.href = '/CSS/sms.css';
                            document.head.appendChild(link);
                        }
                        const existing = document.getElementById('sms-js');
                        if (existing) existing.remove();
                        const script = document.createElement('script');
                        script.src = '/Javascript/sms.js';
                        script.id = 'sms-js';
                        mainContent.appendChild(script);
                    }
                    if (url.includes('admin/staff_management.html')) {
                        const existing = document.getElementById('staff-mgmt-js');
                        if (existing) existing.remove();
                        const script = document.createElement('script');
                        script.src = '/Javascript/staff_management.js';
                        script.id = 'staff-mgmt-js';
                        mainContent.appendChild(script);
                    }
                    if (url.includes('admin/schedule_doses.html')) {
                        if (!document.querySelector('link[href="/CSS/admin.css"]')) {
                            const link = document.createElement('link');
                            link.rel = 'stylesheet';
                            link.href = '/CSS/admin.css';
                            document.head.appendChild(link);
                        }
                        const existing = document.getElementById('schedule-doses-js');
                        if (existing) existing.remove();
                        const script = document.createElement('script');
                        script.src = '/Javascript/schedule_doses.js';
                        script.id = 'schedule-doses-js';
                        mainContent.appendChild(script);
                    }

                    document.querySelectorAll('.menu li').forEach(li => li.classList.remove('active'));
                    element.classList.add('active');
                })
                .catch(err => {
                    document.getElementById('main-content').innerHTML = "<h2>Page not found</h2>";
                    console.error("Error loading page:", err);
                });
        }

    window.onload = () => { if (typeof initRoleMenu === 'function') initRoleMenu(); loadPage('/pages/dashboard.html', document.querySelector('.menu li')); };
    </script>
     <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
     <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>
     <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
    <script src="/Javascript/firebase.js"></script>
     <script>
        function logout(){
            function doSignOut(){
                try {
                    if (window.firebase && firebase.auth) {
                        firebase.auth().signOut().then(function(){
                            window.location.replace('/login.html');
                        }).catch(function(err){
                            console.error('Logout failed', err);
                            window.location.replace('/login.html');
                        });
                    } else {
                        window.location.replace('/login.html');
                    }
                } catch (e) {
                    window.location.replace('/login.html');
                }
            }

            var msg = 'Are you sure you want to log out?';
            if (window.confirmAction) {
                window.confirmAction(msg, doSignOut);
            } else {
                if (confirm(msg)) doSignOut();
            }
        }
     </script>

    <script>
        // Route protection: only allow loading the app when a Firebase user is signed in.
        // Wait until firebase.auth is available, then check the auth state.
        (function(){
            function initAppForUser(user) {
                if (!user) {
                    window.location.replace('/login.html');
                    return;
                }
                // user is signed in — initialize UI
                if (typeof initRoleMenu === 'function') initRoleMenu();
                // load default dashboard
                try {
                    var firstMenuItem = document.querySelector('.menu li');
                    if (firstMenuItem) loadPage('/pages/dashboard.html', firstMenuItem);
                } catch (e) { console.error(e); }
            }

            if (window.firebase && firebase.auth) {
                firebase.auth().onAuthStateChanged(initAppForUser);
            } else {
                var _check = setInterval(function(){
                    if (window.firebase && firebase.auth) {
                        clearInterval(_check);
                        firebase.auth().onAuthStateChanged(initAppForUser);
                    }
                }, 100);
                // safety timeout — if firebase never loads, allow developer to see page
                setTimeout(function(){ clearInterval(_check); }, 5000);
            }
        })();
    </script>

</body>
</html>

